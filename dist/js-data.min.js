/*!
* js-data
* @version 3.0.6 - Homepage <http://www.js-data.io/>
* @author js-data project authors
* @copyright (c) 2014-2016 js-data project authors
* @license MIT <https://github.com/js-data/js-data/blob/master/LICENSE>
*
* @overview js-data is a framework-agnostic, datastore-agnostic ORM/ODM for Node.js and the Browser.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("js-data",["exports"],t):t((e=e||self).JSData={})}(this,function(e){"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){return function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}(e)||function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function _unsupportedIterableToArray(e,t){if(!e)return;if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(e,t)}(e)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function r(e){return t.call(e)}function s(e){return!!e&&"object"===_typeof(e)&&e.constructor===Object}function v(e,t,n){e&&e._set?e._set("props.".concat(t),n):x.set(e,t,n)}function w(e,t,n){e&&e._set?e._set("links.".concat(t),n):x.set(e,t,n)}var n="[object Number]",o="[object RegExp]",t=Object.prototype.toString,i=/^(.+)\.(.+)$/,a={400:function _(e,t,n){return"expected: ".concat(e,", found: ").concat(n?t:_typeof(t))},404:function _(e){return"".concat(e," not found")}},x={Promise:Promise,_:function _(n,e){x.forOwn(e,function(e,t){t&&void 0===n[t]&&!x.isFunction(e)&&0!==t.indexOf("_")&&(n[t]=e)})},_forRelation:function _forRelation(e,t,n,r){var i,o=t.relation,a=null;if((e=e||{}).with||(e.with=[]),0<=(i=x._getIndex(e.with,o))?a=o:0<=(i=x._getIndex(e.with,t.localField))&&(a=t.localField),e.withAll)n.call(r,t,{});else if(a){var s={};x.fillIn(s,t.getRelation()),x.fillIn(s,e),s.with=e.with.slice(),s._activeWith=s.with.splice(i,1)[0],s.with.forEach(function(e,t){e&&0===e.indexOf(a)&&e.length>=a.length&&"."===e[a.length]?s.with[t]=e.substr(a.length+1):s.with[t]=""}),n.call(r,t,s)}},_getIndex:function _getIndex(e,n){var r=-1;return e.forEach(function(e,t){return e===n||x.isObject(e)&&e.relation===n?(r=t,!1):void 0}),r},addHiddenPropsToTarget:function addHiddenPropsToTarget(e,n){var r={};Object.keys(n).forEach(function(e){var t=Object.getOwnPropertyDescriptor(n,e);t.enumerable=!1,r[e]=t}),Object.defineProperties(e,r)},areDifferent:function areDifferent(e,t,n){n=n||{};var r=x.diffObjects(e,t,n);return 0<Object.keys(r.added).length+Object.keys(r.removed).length+Object.keys(r.changed).length},classCallCheck:function classCallCheck(e,t){if(!(e instanceof t))throw x.err("".concat(t.name))(500,"Cannot call a class as a function")},copy:function copy(e,n,t,r,i,o){if(n){if(e===n)throw x.err("".concat("utils",".copy"))(500,"Cannot copy! Source and destination are identical.");if(t=t||[],r=r||[],x.isObject(e)){var a=t.indexOf(e);if(-1!==a)return r[a];t.push(e),r.push(n)}var s,c;if(x.isArray(e))for(c=n.length=0;c<e.length;c++)s=x.copy(e[c],null,t,r,i,o),x.isObject(e[c])&&(t.push(e[c]),r.push(s)),n.push(s);else for(var l in x.isArray(n)?n.length=0:x.forOwn(n,function(e,t){delete n[t]}),e)if(Object.hasOwnProperty.call(e,l)){if(x.isBlacklisted(l,i))continue;s=x.copy(e[l],null,t,r,i,o),x.isObject(e[l])&&(t.push(e[l]),r.push(s)),n[l]=s}}else(n=e)&&(x.isArray(e)?n=x.copy(e,[],t,r,i,o):x.isDate(e)?n=new Date(e.getTime()):x.isRegExp(e)?(n=new RegExp(e.source,e.toString().match(/[^/]*$/)[0])).lastIndex=e.lastIndex:x.isObject(e)&&(n=o?x.copy(e,{},t,r,i,o):x.copy(e,Object.create(Object.getPrototypeOf(e)),t,r,i,o)));return n},deepFillIn:function deepFillIn(r,e){return e&&x.forOwn(e,function(e,t){var n=r[t];s(e)&&s(n)?x.deepFillIn(n,e):Object.hasOwnProperty.call(r,t)&&void 0!==r[t]||(r[t]=e)}),r},deepMixIn:function deepMixIn(e,t){if(t)for(var n in t){var r=t[n],i=e[n];s(r)&&s(i)?x.deepMixIn(i,r):e[n]=r}return e},diffObjects:function diffObjects(r,i,e){var o=(e=e||{}).equalsFn,t=e.ignore,a={added:{},changed:{},removed:{}};x.isFunction(o)||(o=x.deepEqual);var n=Object.keys(r).filter(function(e){return!x.isBlacklisted(e,t)}),s=Object.keys(i).filter(function(e){return!x.isBlacklisted(e,t)});return n.forEach(function(e){var t=i[e],n=r[e];o(t,n)||(void 0===t?a.added[e]=n:a.changed[e]=n)}),s.forEach(function(e){var t=i[e];void 0===r[e]&&void 0!==t&&(a.removed[e]=void 0)}),a},equal:function equal(e,t){return e==t},err:function err(r,i){return function(e){var t="[".concat(r,":").concat(i,"] "),n=a[e].apply(null,Array.prototype.slice.call(arguments,1));return n="".concat(t).concat(n,"\nhttp://www.js-data.io/v3.0/docs/errors#").concat(e),new Error(n)}},eventify:function eventify(e,s,i){e=e||this;var t={};s||i||(s=function getter(){return t},i=function setter(e){t=e}),Object.defineProperties(e,{emit:{value:function value(){for(var e=s.call(this)||{},t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];var i,o=n.shift(),a=e[o]||[];for(i=0;i<a.length;i++)a[i].f.apply(a[i].c,n);for(a=e.all||[],n.unshift(o),i=0;i<a.length;i++)a[i].f.apply(a[i].c,n)}},off:{value:function value(e,t){var n=s.call(this)[e];if(n)if(t){for(var r=0;r<n.length;r++)if(n[r].f===t){n.splice(r,1);break}}else n.splice(0,n.length);else i.call(this,{})}},on:{value:function value(e,t,n){s.call(this)||i.call(this,{});var r=s.call(this);r[e]=r[e]||[],r[e].push({c:n,f:t})}}})},extend:function extend(e,t){var r,i=this;e=e||{},t=t||{},Object.hasOwnProperty.call(e,"constructor")?(r=e.constructor,delete e.constructor):r=function subClass(){x.classCallCheck(this,r);for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];i.apply(this,t)},r.prototype=Object.create(i&&i.prototype,{constructor:{configurable:!0,enumerable:!1,value:r,writable:!0}});var n=Object;return n.setPrototypeOf?n.setPrototypeOf(r,i):t.strictEs6Class?r.__proto__=i:x.forOwn(i,function(e,t){r[t]=e}),Object.hasOwnProperty.call(r,"__super__")||Object.defineProperty(r,"__super__",{configurable:!0,value:i}),x.addHiddenPropsToTarget(r.prototype,e),x.fillIn(r,t),r},fillIn:function fillIn(n,e){x.forOwn(e,function(e,t){Object.hasOwnProperty.call(n,t)&&void 0!==n[t]||(n[t]=e)})},findIndex:function findIndex(e,n){var r=-1;return e&&e.forEach(function(e,t){if(n(e))return r=t,!1}),r},forEachRelation:function forEachRelation(e,t,n,r){var i=e.relationList||[];i.length&&i.forEach(function(e){x._forRelation(t,e,n,r)})},forOwn:function forOwn(e,t,n){var r,i=Object.keys(e),o=i.length;for(r=0;r<o&&!1!==t.call(n,e[i[r]],i[r],e);r++);},fromJson:function fromJson(e){return x.isString(e)?JSON.parse(e):e},get:function get(e,t){if(t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(null==(e=e[t]))return;return e[r]}},getSuper:function getSuper(e,t){var n=t?e:e.constructor;return Object.hasOwnProperty.call(n,"__super__")?n.__super__:Object.getPrototypeOf(n)||n.__proto__},intersection:function intersection(e,t){if(!e||!t)return[];e=Array.isArray(e)?e:[e],t=Array.isArray(t)?t:[t];var n,r,i=[],o=e.length;for(r=0;r<o;r++)n=e[r],-1===i.indexOf(n)&&-1!==t.indexOf(n)&&i.push(n);return i},isArray:Array.isArray,isBlacklisted:function isBlacklisted(e,t){if(!t||!t.length)return!1;for(var n,i=0;i<t.length;i++)if(r(t[i])===o&&t[i].test(e)||t[i]===e)return!!(n=e);return!!n},isBoolean:function isBoolean(e){return"[object Boolean]"===r(e)},isDate:function isDate(e){return e&&"object"===_typeof(e)&&"[object Date]"===r(e)},isFunction:function isFunction(e){return"function"==typeof e||e&&"[object Function]"===r(e)},isInteger:function isInteger(e){return r(e)===n&&e==function toInteger(e){if(!e)return 0;if((e=+e)===1/0||e===-1/0)return 17976931348623157e292*(e<0?-1:1);var t=e%1;return e==e?t?e-t:e:0}(e)},isNull:function isNull(e){return null===e},isNumber:function isNumber(e){var t=_typeof(e);return"number"===t||e&&"object"===t&&r(e)===n},isObject:function isObject(e){return"[object Object]"===r(e)},isRegExp:function isRegExp(e){return r(e)===o},isSorN:function isSorN(e){return x.isString(e)||x.isNumber(e)},isString:function isString(e){return"string"==typeof e||e&&"object"===_typeof(e)&&"[object String]"===r(e)},isUndefined:function isUndefined(e){return void 0===e},logify:function logify(e){x.addHiddenPropsToTarget(e,{dbg:function dbg(){if(x.isFunction(this.log)){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.log.apply(this,["debug"].concat(t))}},log:function log(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(e&&!n.length&&(n.push(e),e="debug"),"debug"!==e||this.debug){var i,o,a="".concat(e.toUpperCase(),": (").concat(this.name||this.constructor.name,")");if(x.isFunction(console[e]))(i=console)[e].apply(i,[a].concat(n));else(o=console).log.apply(o,[a].concat(n))}}})},noDupeAdd:function noDupeAdd(e,t,n){e&&this.findIndex(e,n)<0&&e.push(t)},omit:function omit(e,n){var r={};return x.forOwn(e,function(e,t){-1===n.indexOf(t)&&(r[t]=e)}),r},pick:function pick(n,e){return e.reduce(function(e,t){return e[t]=n[t],e},{})},plainCopy:function plainCopy(e){return x.copy(e,void 0,void 0,void 0,void 0,!0)},reject:function reject(e){return x.Promise.reject(e)},remove:function remove(e,t){if(e&&e.length){var n=this.findIndex(e,t);0<=n&&e.splice(n,1)}},resolve:function resolve(e){return x.Promise.resolve(e)},set:function set(n,e,t){if(x.isObject(e))x.forOwn(e,function(e,t){x.set(n,t,e)});else{var r=i.exec(e);r?function mkdirP(t,e){return e&&e.split(".").forEach(function(e){t[e]||(t[e]={}),t=t[e]}),t}(n,r[1])[r[2]]=t:n[e]=t}},deepEqual:function deepEqual(n,r){if(n===r)return!0;var i=!0;if(x.isArray(n)&&x.isArray(r)){if(n.length!==r.length)return!1;for(var e=n.length;e--;)if(!x.deepEqual(n[e],r[e]))return!1}else{if(!x.isObject(n)||!x.isObject(r))return!1;x.forOwn(n,function(e,t){if(!(i=x.deepEqual(e,r[t])))return!1}),i&&x.forOwn(r,function(e,t){if(!(i=x.deepEqual(e,n[t])))return!1})}return i},toJson:JSON.stringify,unset:function unset(e,t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(null==(e=e[t]))return;e[r]=void 0}};function Settable(){var n={};Object.defineProperties(this,{_get:{value:function value(e){return x.get(n,e)}},_set:{value:function value(e,t){return x.set(n,e,t)}},_unset:{value:function value(e){return x.unset(n,e)}}})}function Component(e){Settable.call(this),e=e||{},this.debug=!!Object.hasOwnProperty.call(e,"debug")&&!!e.debug,Object.defineProperty(this,"_listeners",{value:{},writable:!0})}Settable.extend=x.extend;var c=Settable.extend({constructor:Component});Component.extend=x.extend,x.logify(Component.prototype),x.eventify(Component.prototype,function(){return this._listeners},function(e){this._listeners=e});var l="Query",u="Index inaccessible after first operation",f={limit:"",offset:"",orderBy:"",skip:"",sort:"",where:""},d=/([.*+?^=!:${}()|[\]/\\])/g,h=/%/g,p=/_/g;var g=c.extend({constructor:function Query(e){x.classCallCheck(this,Query),this.collection=e,this.data=null},_applyWhereFromObject:function _applyWhereFromObject(e){var r=[],i=[],o=[];return x.forOwn(e,function(e,n){x.isObject(e)||(e={"==":e}),x.forOwn(e,function(e,t){r.push(n),i.push(t),o.push(e)})}),{fields:r,ops:i,predicates:o}},_applyWhereFromArray:function _applyWhereFromArray(i){var o=this,a=[];return i.forEach(function(e,t){if(!x.isString(e)){var n=i[t-1],r=(x.isArray(e)?o._applyWhereFromArray:o._applyWhereFromObject).call(o,e);"or"===n&&(r.isOr=!0),a.push(r)}}),a.isArray=!0,a},_testObjectGroup:function _testObjectGroup(e,t,n,r){var i,o=n.fields,a=n.ops,s=n.predicates,c=a.length;for(i=0;i<c;i++){var l=a[i],u="|"===l.charAt(0);l=u?l.substr(1):l;var f=this.evaluate(x.get(r,o[i]),l,s[i]);void 0!==f&&(e=t?f:u?e||f:e&&f),t=!1}return{keep:e,first:t}},_testArrayGroup:function _testArrayGroup(e,t,n,r){var i,o=n.length;for(i=0;i<o;i++){var a=n[i],s=(a.isArray?this._testArrayGroup:this._testObjectGroup).call(this,!0,!0,a,r);e=n[i-1]?a.isOr?e||s.keep:e&&s.keep:s.keep,t=s.first}return{keep:e,first:t}},between:function between(e,t,n){if(n=n||{},this.data)throw x.err("".concat(l,"#between"))(500,"Cannot access index");return this.data=this.collection.getIndex(n.index).between(e,t,n),this},compare:function compare(e,t,n,r){var i=e[t],o=x.get(n,i[0]),a=x.get(r,i[0]);if(o&&x.isString(o)&&(o=o.toUpperCase()),a&&x.isString(a)&&(a=a.toUpperCase()),void 0===n&&(n=null),void 0===r&&(r=null),"DESC"===i[1].toUpperCase()){var s=a;a=o,o=s}return o<a?-1:a<o?1:t<e.length-1?this.compare(e,t+1,n,r):0},evaluate:function evaluate(e,t,n){var r=this.constructor.ops;return r[t]?r[t](e,n):0===t.indexOf("like")?null!==this.like(n,t.substr(4)).exec(e):0===t.indexOf("notLike")?null===this.like(n,t.substr(7)).exec(e):void 0},filter:function filter(e,t){var n=this;if(e=e||{},this.getData(),x.isObject(e)){var r,i={};(x.isObject(e.where)||x.isArray(e.where))&&(i=e.where),x.forOwn(e,function(e,t){t in f||t in i||(i[t]={"==":e})}),x.isObject(i)&&0!==Object.keys(i).length?r=this._applyWhereFromArray([i]):x.isArray(i)&&(r=this._applyWhereFromArray(i)),r&&(this.data=this.data.filter(function(e,t){return n._testArrayGroup(!0,!0,r,e).keep}));var o=e.orderBy||e.sort;if(x.isString(o)&&(o=[[o,"ASC"]]),x.isArray(o)||(o=null),o){o.forEach(function(e,t){x.isString(e)&&(o[t]=[e,"ASC"])}),this.data.sort(function(e,t){return n.compare(o,0,e,t)})}x.isNumber(e.skip)?this.skip(e.skip):x.isNumber(e.offset)&&this.skip(e.offset),x.isNumber(e.limit)&&this.limit(e.limit)}else x.isFunction(e)&&(this.data=this.data.filter(e,t));return this},forEach:function forEach(e,t){return this.getData().forEach(e,t),this},get:function get(e,t){if(e=e||[],t=t||{},this.data)throw x.err("".concat(l,"#get"))(500,u);return e&&!x.isArray(e)&&(e=[e]),e.length?this.data=this.collection.getIndex(t.index).get(e):this.getData(),this},getAll:function getAll(){var t=this,e={};if(this.data)throw x.err("".concat(l,"#getAll"))(500,u);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];if(!r.length||1===r.length&&x.isObject(r[0]))return this.getData(),this;r.length&&x.isObject(r[r.length-1])&&(e=r[r.length-1],r.pop());var o=this.collection.getIndex(e.index);return this.data=[],r.forEach(function(e){t.data=t.data.concat(o.get(e))}),this},getData:function getData(){return this.data||(this.data=this.collection.index.getAll()),this.data},like:function like(e,t){return new RegExp("^".concat(function escape(e){return e.replace(d,"\\$1")}(e).replace(h,".*").replace(p,"."),"$"),t)},limit:function limit(e){if(!x.isNumber(e))throw x.err("".concat(l,"#limit"),"num")(400,"number",e);var t=this.getData();return this.data=t.slice(0,Math.min(t.length,e)),this},map:function map(e,t){return this.data=this.getData().map(e,t),this},mapCall:function mapCall(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return this.data=this.getData().map(function(e){return e[t].apply(e,n)}),this},run:function run(){var e=this.data;return this.data=null,e},skip:function skip(e){if(!x.isNumber(e))throw x.err("".concat(l,"#skip"),"num")(400,"number",e);var t=this.getData();return e<t.length?this.data=t.slice(e):this.data=[],this}},{ops:{"=":function _(e,t){return e==t},"==":function _(e,t){return e==t},"===":function _(e,t){return e===t},"!=":function _(e,t){return e!=t},"!==":function _(e,t){return e!==t},">":function _(e,t){return t<e},">=":function _(e,t){return t<=e},"<":function _(e,t){return e<t},"<=":function _(e,t){return e<=t},isectEmpty:function isectEmpty(e,t){return!x.intersection(e||[],t||[]).length},isectNotEmpty:function isectNotEmpty(e,t){return x.intersection(e||[],t||[]).length},in:function _in(e,t){return-1!==t.indexOf(e)},notIn:function notIn(e,t){return-1===t.indexOf(e)},contains:function contains(e,t){return-1!==(e||[]).indexOf(t)},notContains:function notContains(e,t){return-1===(e||[]).indexOf(t)}}}),C="belongsTo",k="hasMany",I="hasOne";function Relation(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};x.classCallCheck(this,Relation),t.type=this.constructor.TYPE_NAME,this.validateOptions(e,t),"object"===_typeof(e)&&Object.defineProperty(this,"relatedMapper",{value:e}),Object.defineProperty(this,"inverse",{writable:!0}),x.fillIn(this,t)}Relation.extend=x.extend,x.addHiddenPropsToTarget(Relation.prototype,{get canAutoAddLinks(){return void 0===this.add||!!this.add},get relatedCollection(){return this.mapper.datastore.getCollection(this.relation)},validateOptions:function validateOptions(e,t){var n="new ".concat("Relation"),r=t.localField;if(!r)throw x.err(n,"opts.localField")(400,"string",r);var i=t.foreignKey=t.foreignKey||t.localKey;if(!i&&(t.type===C||t.type===I))throw x.err(n,"opts.foreignKey")(400,"string",i);if(x.isString(e)){if(t.relation=e,!x.isFunction(t.getRelation))throw x.err(n,"opts.getRelation")(400,"function",t.getRelation)}else{if(!e)throw x.err(n,"related")(400,"Mapper or string",e);t.relation=e.name}},assignTo:function assignTo(e){this.name=e.name,Object.defineProperty(this,"mapper",{value:e}),e.relationList||Object.defineProperty(e,"relationList",{value:[]}),e.relationFields||Object.defineProperty(e,"relationFields",{value:[]}),e.relationList.push(this),e.relationFields.push(this.localField)},canFindLinkFor:function canFindLinkFor(){return!(!this.foreignKey&&!this.localKey)},getRelation:function getRelation(){return this.relatedMapper},getForeignKey:function getForeignKey(e){return x.get(e,this.mapper.idAttribute)},setForeignKey:function setForeignKey(e,t){e&&t&&this._setForeignKey(e,t)},_setForeignKey:function _setForeignKey(t,e){var n=this,r=this.mapper.idAttribute;x.isArray(e)||(e=[e]),e.forEach(function(e){x.set(e,n.foreignKey,x.get(t,r))})},getLocalField:function getLocalField(e){return x.get(e,this.localField)},setLocalField:function setLocalField(e,t){return x.set(e,this.localField,t)},getInverse:function getInverse(e){return this.inverse||this.findInverseRelation(e),this.inverse},findInverseRelation:function findInverseRelation(t){var n=this;this.getRelation().relationList.forEach(function(e){if(e.getRelation()===t&&n.isInversedTo(e)&&n!==e)return n.inverse=e,!0})},isInversedTo:function isInversedTo(e){return!e.foreignKey||e.foreignKey===this.foreignKey},addLinkedRecords:function addLinkedRecords(e){var n=this,r=this.mapper.datastore;e.forEach(function(e){var t=n.getLocalField(e);(!(t=x.isFunction(n.add)?n.add(r,n,e):t&&n.linkRecord(e,t))||x.isArray(t)&&!t.length)&&n.canFindLinkFor(e)&&(t=n.findExistingLinksFor(e)),t&&n.setLocalField(e,t)})},removeLinkedRecords:function removeLinkedRecords(e,t){var n=this.localField;t.forEach(function(e){x.set(e,n,void 0)})},linkRecord:function linkRecord(e,t){var n=x.get(t,this.mapper.idAttribute);void 0===n?-1===this.relatedCollection.unsaved().indexOf(t)&&this.canAutoAddLinks&&(t=this.relatedCollection.add(t)):t!==this.relatedCollection.get(n)&&(this.setForeignKey(e,t),this.canAutoAddLinks&&(t=this.relatedCollection.add(t)));return t},findExistingLinksByForeignKey:function findExistingLinksByForeignKey(e){if(null!=e)return this.relatedCollection.filter(_defineProperty({},this.foreignKey,e))},ensureLinkedDataHasProperType:function ensureLinkedDataHasProperType(e,t){var n=this.getRelation(),r=this.getLocalField(e);x.isArray(r)&&(!r.length||n.is(r[0]))||!r||n.is(r)||x.set(e,this.localField,n.createRecord(r,t))},isRequiresParentId:function isRequiresParentId(){return!1},isRequiresChildId:function isRequiresChildId(){return!1},createChildRecord:function createChildRecord(t,e,n){var r=this;return this.setForeignKey(t,e),this.createLinked(e,n).then(function(e){r.setLocalField(t,e)})},createLinked:function createLinked(e,t){var n=x.isArray(e)?"createMany":"create";return this.getRelation()[n](e,t)}}),[Relation.extend({getForeignKey:function getForeignKey(e){return x.get(e,this.foreignKey)},_setForeignKey:function _setForeignKey(e,t){x.set(e,this.foreignKey,x.get(t,this.getRelation().idAttribute))},findExistingLinksFor:function findExistingLinksFor(e){if(e){var t=x.get(e,this.foreignKey);return null!=t?this.relatedCollection.get(t):void 0}},isRequiresParentId:function isRequiresParentId(){return!0},createParentRecord:function createParentRecord(t,e){var n=this,r=this.getLocalField(t);return this.createLinked(r,e).then(function(e){n.setForeignKey(t,e)})},createChildRecord:function createChildRecord(){throw new Error('"BelongsTo" relation does not support child creation as it cannot have children.')}},{TYPE_NAME:"belongsTo"}),Relation.extend({validateOptions:function validateOptions(e,t){Relation.prototype.validateOptions.call(this,e,t);var n=t.localKeys,r=t.foreignKeys,i=t.foreignKey;if(!i&&!n&&!r)throw x.err("new Relation","opts.<foreignKey|localKeys|foreignKeys>")(400,"string",i)},canFindLinkFor:function canFindLinkFor(e){return!!(this.foreignKey||this.foreignKeys||this.localKeys&&x.get(e,this.localKeys))},linkRecord:function linkRecord(n,e){var r=this,i=this.relatedCollection,o=this.canAutoAddLinks,a=this.foreignKey,s=this.relatedCollection.unsaved();return e.map(function(e){var t=i.recordId(e);return(void 0===t&&-1===s.indexOf(e)||e!==i.get(t))&&(a&&r.setForeignKey(n,e),o&&(e=i.add(e))),e})},findExistingLinksFor:function findExistingLinksFor(e){var t,n=x.get(e,this.mapper.idAttribute),r=this.localKeys?x.get(e,this.localKeys):null;if(void 0!==n&&this.foreignKey?t=this.findExistingLinksByForeignKey(n):this.localKeys&&r?t=this.findExistingLinksByLocalKeys(r):void 0!==n&&this.foreignKeys&&(t=this.findExistingLinksByForeignKeys(n)),t&&t.length)return t},findExistingLinksByLocalKeys:function findExistingLinksByLocalKeys(e){return this.relatedCollection.filter({where:_defineProperty({},this.relatedCollection.mapper.idAttribute,{in:e})})},findExistingLinksByForeignKeys:function findExistingLinksByForeignKeys(e){return this.relatedCollection.filter({where:_defineProperty({},this.foreignKeys,{contains:e})})},isRequiresParentId:function isRequiresParentId(){return!!this.localKeys&&0<this.localKeys.length},isRequiresChildId:function isRequiresChildId(){return!!this.foreignKey},createParentRecord:function createParentRecord(t,e){var n=this,r=this.getLocalField(t),i=this.getRelation().idAttribute;return this.createLinked(r,e).then(function(e){x.set(t,n.localKeys,e.map(function(e){return x.get(e,i)}))})},createLinked:function createLinked(e,t){return this.getRelation().createMany(e,t)}},{TYPE_NAME:"hasMany"}),Relation.extend({findExistingLinksFor:function findExistingLinksFor(e,t){var n=x.get(t,e.idAttribute),r=this.findExistingLinksByForeignKey(n);if(r&&r.length)return r[0]},isRequiresChildId:function isRequiresChildId(){return!0}},{TYPE_NAME:"hasOne"})].forEach(function(n){Relation[n.TYPE_NAME]=function(e,t){return new n(e,t)}});function N(t,n){return function(e){Relation.belongsTo(t,n).assignTo(e)}}function O(t,n){return function(e){Relation.hasMany(t,n).assignTo(e)}}function P(t,n){return function(e){Relation.hasOne(t,n).assignTo(e)}}function R(r,i){var o=r.datastore;return o&&o[i]?function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o[i].apply(o,[r.name].concat(t))}:r[i].bind(r)}var y="creating",m="noValidate",A="keepChangeHistory",b="previous";function Record(e,t){x.classCallCheck(this,Record),Settable.call(this),e=e||{},t=t||{};var n=this._set,r=this.constructor.mapper;n(y,!0),n(m,!!t.noValidate),n(A,void 0===t.keepChangeHistory?!r||r.keepChangeHistory:t.keepChangeHistory);var i=r?x.get(e,r.idAttribute):void 0;void 0!==i&&x.set(this,r.idAttribute,i),x.fillIn(this,e),n(y,!1),void 0!==t.validateOnSet?n(m,!t.validateOnSet):r&&void 0!==r.validateOnSet?n(m,!r.validateOnSet):n(m,!1),n(b,r?r.toJSON(e):x.plainCopy(e))}var F=c.extend({constructor:Record,_mapper:function _mapper(){var e=this.constructor.mapper;if(!e)throw x.err("".concat("Record","#_mapper"),"")(404,"mapper");return e},afterLoadRelations:function afterLoadRelations(){},beforeLoadRelations:function beforeLoadRelations(){},changeHistory:function changeHistory(){return(this._get("history")||[]).slice()},changes:function changes(e){return e=e||{},x.diffObjects("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)},commit:function commit(e){this._set("changed"),this._set("changing",!1),this._set("history",[]),this._set("previous",this.toJSON(e))},destroy:function destroy(e){e=e||{};var t=this._mapper();return R(t,"destroy")(x.get(this,t.idAttribute),e)},get:function get(e){return x.get(this,e)},hasChanges:function hasChanges(e){return!!(this._get("changed")||[]).length||x.areDifferent("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)},isNew:function isNew(){return void 0===x.get(this,this._mapper().idAttribute)},isValid:function isValid(e){return!this._mapper().validate(this,e)},removeInverseRelation:function removeInverseRelation(e,t,n,r){var i=this;if(n.type===I)w(e,n.localField,void 0);else if(n.type===k){var o=x.get(e,n.localField);void 0===t?x.remove(o,function(e){return e===i}):x.remove(o,function(e){return e===i||t===x.get(e,r)})}},setupInverseRelation:function setupInverseRelation(e,t,n,r){var i=this;if(n.type===I)w(e,n.localField,this);else if(n.type===k){var o=x.get(e,n.localField);void 0===t?x.noDupeAdd(o,this,function(e){return e===i}):x.noDupeAdd(o,this,function(e){return e===i||t===x.get(e,r)})}},loadRelations:function loadRelations(e,a){var t,s=this,c=this._mapper();return e=e||[],x.isString(e)&&(e=[e]),(a=a||{}).with=e,x._(a,c),a.adapter=c.getAdapterName(a),t=a.op="beforeLoadRelations",x.resolve(this[t](e,a)).then(function(){t=a.op="loadRelations",c.dbg(t,s,e,a);var i,o=[];return x.forEachRelation(c,a,function(t,e){var n=t.getRelation();if(e.raw=!1,x.isFunction(t.load))i=t.load(c,t,s,a);else if("hasMany"===t.type||"hasOne"===t.type)t.foreignKey?i=R(n,"findAll")(_defineProperty({},t.foreignKey,x.get(s,c.idAttribute)),e).then(function(e){return"hasOne"===t.type?e.length?e[0]:void 0:e}):t.localKeys?i=R(n,"findAll")({where:_defineProperty({},n.idAttribute,{in:x.get(s,t.localKeys)})}):t.foreignKeys&&(i=R(n,"findAll")({where:_defineProperty({},t.foreignKeys,{contains:x.get(s,c.idAttribute)})},a));else if("belongsTo"===t.type){var r=x.get(s,t.foreignKey);x.isSorN(r)&&(i=R(n,"find")(r,e))}i&&(i=i.then(function(e){t.setLocalField(s,e)}),o.push(i))}),Promise.all(o)}).then(function(){return t=a.op="afterLoadRelations",x.resolve(s[t](e,a)).then(function(){return s})})},previous:function previous(e){return e?this._get("previous.".concat(e)):this._get("previous")},revert:function revert(n){var r=this,i=this._get("previous");(n=n||{}).preserve||(n.preserve=[]),x.forOwn(this,function(e,t){t!==r._mapper().idAttribute&&!Object.hasOwnProperty.call(i,t)&&Object.hasOwnProperty.call(r,t)&&-1===n.preserve.indexOf(t)&&delete r[t]}),x.forOwn(i,function(e,t){-1===n.preserve.indexOf(t)&&(r[t]=e)}),this.commit()},save:function save(n){var r=this;n=n||{};function al(e){var t=n.raw?e.data:e;return t&&(x.deepMixIn(r,t),r.commit()),e}var e=this._mapper(),t=x.get(this,e.idAttribute),i=this;if(void 0===t)return R(e,"create")(i,n).then(al);if(n.changesOnly){var o=this.changes(n);i={},x.fillIn(i,o.added),x.fillIn(i,o.changed)}return R(e,"update")(t,i,n).then(al)},set:function set(e,t,n){x.isObject(e)&&(n=t),(n=n||{}).silent&&this._set("silent",!0),x.set(this,e,t),this._get("eventId")||this._set("silent")},toJSON:function toJSON(e){var t=this.constructor.mapper;if(t)return t.toJSON(this,e);var n={};return x.forOwn(this,function(e,t){n[t]=x.plainCopy(e)}),n},unset:function unset(e,t){this.set(e,void 0,t)},validate:function validate(e){return this._mapper().validate(this,e)}},{creatingPath:y,noValidatePath:m,keepChangeHistoryPath:A,previousPath:b});function insertAt(e,t,n){return e.splice(t,0,n),e}function removeAt(e,t){return e.splice(t,1),e}function binarySearch(e,t,n){for(var r,i,o,a,s,c=0,l=e.length;c<l;){if(o=t,a=e[i=(c+l)/2|0],s=n,0==(r=o===a?0:(s&&(o=s(o),a=s(a)),null===o&&null===a||void 0===o&&void 0===a||null==o?-1:null==a?1:o<a?-1:a<o?1:0)))return{found:!0,index:i};r<0?l=i:c=1+i}return{found:!1,index:l}}function Index(e,t){if(x.classCallCheck(this,Index),e=e||[],!x.isArray(e))throw new Error("fieldList must be an array.");t=t||{},this.fieldList=e,this.fieldGetter=t.fieldGetter,this.hashCode=t.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}x.eventify(Record.prototype,function(){return this._get("events")},function(e){this._set("events",e)}),x.addHiddenPropsToTarget(Index.prototype,{set:function set(e,t){x.isArray(e)||(e=[e]);var n=e.shift()||void 0,r=binarySearch(this.keys,n);if(0===e.length)if(r.found){var i=binarySearch(this.values[r.index],t,this.hashCode);i.found||insertAt(this.values[r.index],i.index,t)}else insertAt(this.keys,r.index,n),insertAt(this.values,r.index,[t]);else if(r.found)this.values[r.index].set(e,t);else{insertAt(this.keys,r.index,n);var o=new Index([],{hashCode:this.hashCode});o.set(e,t),insertAt(this.values,r.index,o)}},get:function get(e){x.isArray(e)||(e=[e]);var t=e.shift()||void 0,n=binarySearch(this.keys,t);return 0===e.length?n.found?this.values[n.index].isIndex?this.values[n.index].getAll():this.values[n.index].slice():[]:n.found?this.values[n.index].get(e):[]},getAll:function getAll(e){e=e||{};var t=[],n=this.values;if("desc"===e.order)for(var r=n.length-1;0<=r;r--){var i=n[r];t=i.isIndex?t.concat(i.getAll(e)):t.concat(i)}else for(var o=0;o<n.length;o++){var a=n[o];t=a.isIndex?t.concat(a.getAll(e)):t.concat(a)}return t},visitAll:function visitAll(t,n){this.values.forEach(function(e){e.isIndex?e.visitAll(t,n):e.forEach(t,n)})},between:function between(e,t,n){n=n||{},x.isArray(e)||(e=[e]),x.isArray(t)||(t=[t]),x.fillIn(n,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var r=this._between(e,t,n);return n.limit?r.slice(n.offset,n.limit+n.offset):r.slice(n.offset)},_between:function _between(e,t,n){var r,i=[],o=e.shift(),a=t.shift();if(r=void 0!==o?binarySearch(this.keys,o):{found:!1,index:0},0===e.length){r.found&&!1===n.leftInclusive&&(r.index+=1);for(var s=r.index;s<this.keys.length;s+=1){if(void 0!==a)if(n.rightInclusive){if(this.keys[s]>a)break}else if(this.keys[s]>=a)break;if(i=this.values[s].isIndex?i.concat(this.values[s].getAll()):i.concat(this.values[s]),n.limit&&i.length>=n.limit+n.offset)break}}else for(var c=r.index;c<this.keys.length;c+=1){var l=this.keys[c];if(a<l)break;if(i=this.values[c].isIndex?l===o?i.concat(this.values[c]._between(x.copy(e),t.map(function(){}),n)):l===a?i.concat(this.values[c]._between(e.map(function(){}),x.copy(t),n)):i.concat(this.values[c].getAll()):i.concat(this.values[c]),n.limit&&i.length>=n.limit+n.offset)break}return n.limit?i.slice(0,n.limit+n.offset):i},peek:function peek(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]},clear:function clear(){this.keys=[],this.values=[]},insertRecord:function insertRecord(t){var e=this.fieldList.map(function(e){return x.isFunction(e)?e(t)||void 0:t[e]||void 0});this.set(e,t)},removeRecord:function removeRecord(i){var o,a=this,s=void 0!==this.hashCode(i);return this.values.forEach(function(e,t){if(e.isIndex){if(e.removeRecord(i))return 0===e.keys.length&&(removeAt(a.keys,t),removeAt(a.values,t)),!(o=!0)}else{var n={};if(void 0!==a.keys[t]&&s)s&&(n=binarySearch(e,i,a.hashCode));else for(var r=e.length-1;0<=r;r--)if(e[r]===i){n={found:!0,index:r};break}if(n.found)return removeAt(e,n.index),0===e.length&&(removeAt(a.keys,t),removeAt(a.values,t)),!(o=!0)}}),o?i:void 0},updateRecord:function updateRecord(e){void 0!==this.removeRecord(e)&&this.insertRecord(e)}});var E=F.noValidatePath,j="Collection",S={commitOnMerge:!0,emitRecordEvents:!0,idAttribute:"id",onConflict:"merge"};function ca(e,t){var n="";return e&&(x.isNumber(e)?n+="[".concat(e,"]"):n+=t?".".concat(e):"".concat(e)),n}function ea(e,t,n){return{expected:t,actual:""+e,path:function makePath(e){var t="";return((e=e||{}).path||[]).forEach(function(e){t+=ca(e,t)}),t+=ca(e.prop,t)}(n)}}function fa(e,t,n,r){r.push(ea(e,t,n))}function ga(e,t,n,r){var i=n[e];if(t.length>i)return ea(t.length,"length no more than ".concat(i),r)}function ha(e,t,n,r){var i=n[e];if(t.length<i)return ea(t.length,"length no less than ".concat(i),r)}function ja(e,t,n,r){var i=[];return e.forEach(function(e){void 0!==n[e]&&(i=i.concat(K[e](t,n,r)||[]))}),i.length?i:void 0}var L=c.extend({constructor:function Collection(e,t){x.classCallCheck(this,Collection),c.call(this,t),e&&!x.isArray(e)&&(t=e,e=[]),x.isString(t)&&(t={idAttribute:t}),e=e||[],t=t||{},Object.defineProperties(this,{mapper:{value:void 0,writable:!0},queryClass:{value:void 0,writable:!0}}),x.fillIn(this,t),x.fillIn(this,x.copy(S)),this.queryClass||(this.queryClass=g);var n=this.recordId();Object.defineProperties(this,{index:{value:new Index([n],{hashCode:function hashCode(e){return x.get(e,n)}})},indexes:{value:{}}}),(x.isObject(e)||x.isArray(e)&&e.length)&&this.add(e)},_onRecordEvent:function _onRecordEvent(){this.emitRecordEvents&&this.emit.apply(this,arguments)},add:function add(e,o){var a=this;o=o||{},x._(o,this),e=this.beforeAdd(e,o)||e;var t=!1,s=this.recordId();if(!x.isArray(e)){if(!x.isObject(e))throw x.err("".concat(j,"#add"),"records")(400,"object or array",e);e=[e],t=!0}e=e.map(function(n){var e=a.recordId(n),r=void 0===e?e:a.get(e);if(n===r)return r;if(r){var t=o.onConflict||a.onConflict;if("merge"!==t&&"replace"!==t&&"skip"!==t)throw x.err("".concat(j,"#add"),"opts.onConflict")(400,"one of (merge, replace, skip)",t,!0);var i=r._get(E);o.noValidate&&r._set(E,!0),"merge"===t?x.deepMixIn(r,n):"replace"===t&&(x.forOwn(r,function(e,t){t!==s&&void 0===n[t]&&(r[t]=void 0)}),r.set(n)),o.noValidate&&r._set(E,i),n=r,o.commitOnMerge&&x.isFunction(n.commit)&&n.commit(),a.updateIndexes(n)}else n=a.mapper?a.mapper.createRecord(n,o):n,a.index.insertRecord(n),x.forOwn(a.indexes,function(e,t){e.insertRecord(n)}),n&&x.isFunction(n.on)&&n.on("all",a._onRecordEvent,a);return n});var n=t?e[0]:e;return o.silent||this.emit("add",n),this.afterAdd(e,o,n)||n},afterAdd:function afterAdd(){},afterRemove:function afterRemove(){},afterRemoveAll:function afterRemoveAll(){},beforeAdd:function beforeAdd(){},beforeRemove:function beforeRemove(){},beforeRemoveAll:function beforeRemoveAll(){},between:function between(e,t,n){return this.query().between(e,t,n).run()},createIndex:function createIndex(e,t,n){var r=this;x.isString(e)&&void 0===t&&(t=[e]),(n=n||{}).hashCode||(n.hashCode=function(e){return r.recordId(e)});var i=this.indexes[e]=new Index(t,n);this.index.visitAll(i.insertRecord,i)},filter:function filter(e,t){return this.query().filter(e,t).run()},forEach:function forEach(e,t){this.index.visitAll(e,t)},get:function get(e){var t=void 0===e?[]:this.query().get(e).run();return t.length?t[0]:void 0},getAll:function getAll(){var e;return(e=this.query()).getAll.apply(e,arguments).run()},getIndex:function getIndex(e){var t=e?this.indexes[e]:this.index;if(!t)throw x.err("".concat(j,"#getIndex"),e)(404,"index");return t},limit:function limit(e){return this.query().limit(e).run()},map:function map(t,n){var r=[];return this.index.visitAll(function(e){r.push(t.call(n,e))}),r},mapCall:function mapCall(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];var i=[];return this.index.visitAll(function(e){i.push(e[t].apply(e,n))}),i},prune:function prune(e){return this.removeAll(this.unsaved(),e)},query:function query(){return new this.queryClass(this)},recordId:function recordId(e){return e?x.get(e,this.recordId()):this.mapper?this.mapper.idAttribute:this.idAttribute},reduce:function reduce(e,t){return this.getAll().reduce(e,t)},remove:function remove(e,t){t=t||{},this.beforeRemove(e,t);var n=x.isSorN(e)?this.get(e):e;return x.isObject(n)&&(n=this.index.removeRecord(n))&&(x.forOwn(this.indexes,function(e,t){e.removeRecord(n)}),x.isFunction(n.off)&&n.off("all",this._onRecordEvent,this),t.silent||this.emit("remove",n)),this.afterRemove(e,t,n)||n},removeAll:function removeAll(e,t){var n=this;t=t||{},this.beforeRemoveAll(e,t);var r=x.isArray(e)?e.slice():this.filter(e),i=x.plainCopy(t);return i.silent=!0,r=r.map(function(e){return n.remove(e,i)}).filter(function(e){return e}),t.silent||this.emit("remove",r),this.afterRemoveAll(e,t,r)||r},skip:function skip(e){return this.query().skip(e).run()},toJSON:function toJSON(e){return this.mapCall("toJSON",e)},unsaved:function unsaved(){return this.index.get()},updateIndex:function updateIndex(e,t){t=t||{},this.getIndex(t.index).updateRecord(e)},updateIndexes:function updateIndexes(n){this.index.updateRecord(n),x.forOwn(this.indexes,function(e,t){e.updateRecord(n)})}}),M={array:x.isArray,boolean:x.isBoolean,integer:x.isInteger,null:x.isNull,number:x.isNumber,object:x.isObject,string:x.isString},K={allOf:function allOf(t,e,n){var r=[];return e.allOf.forEach(function(e){r=r.concat(B(t,e,n)||[])}),r.length?r:void 0},anyOf:function anyOf(n,e,r){var i=!1,o=[];return e.anyOf.forEach(function(e){var t=B(n,e,r);t?o=o.concat(t):i=!0}),i?void 0:o},dependencies:function dependencies(){},enum:function _enum(t,e,n){var r=e.enum;if(-1===x.findIndex(r,function(e){return x.deepEqual(e,t)}))return ea(t,"one of (".concat(r.join(", "),")"),n)},items:function items(e,t,n){n=n||{};for(var items=t.items,r=[],i=x.isArray(items),o=e.length,a=0;a<o;a++)i&&(items=t.items[a]),n.prop=a,r=r.concat(B(e[a],items,n)||[]);return r.length?r:void 0},maximum:function maximum(e,t,n){var maximum=t.maximum,r=t.exclusiveMaximum;if(_typeof(e)===_typeof(maximum)&&!(r?e<maximum:e<=maximum))return ea(e,r?"no more than nor equal to ".concat(maximum):"no more than ".concat(maximum),n)},maxItems:function maxItems(e,t,n){if(x.isArray(e))return ga("maxItems",e,t,n)},maxLength:function maxLength(e,t,n){return ga("maxLength",e,t,n)},maxProperties:function maxProperties(e,t,n){if(x.isObject(e)){var maxProperties=t.maxProperties,r=Object.keys(e).length;return maxProperties<r?ea(r,"no more than ".concat(maxProperties," properties"),n):void 0}},minimum:function minimum(e,t,n){var minimum=t.minimum,r=t.exclusiveMinimum;if(_typeof(e)===_typeof(minimum)&&!(r?minimum<e:minimum<=e))return ea(e,r?"no less than nor equal to ".concat(minimum):"no less than ".concat(minimum),n)},minItems:function minItems(e,t,n){if(x.isArray(e))return ha("minItems",e,t,n)},minLength:function minLength(e,t,n){return ha("minLength",e,t,n)},minProperties:function minProperties(e,t,n){if(x.isObject(e)){var minProperties=t.minProperties,r=Object.keys(e).length;return r<minProperties?ea(r,"no more than ".concat(minProperties," properties"),n):void 0}},multipleOf:function multipleOf(e,t,n){var multipleOf=t.multipleOf;if(x.isNumber(e)&&e/multipleOf%1!=0)return ea(e,"multipleOf ".concat(multipleOf),n)},not:function not(e,t,n){if(!B(e,t.not,n))return ea("succeeded","should have failed",n)},oneOf:function oneOf(n,e,r){var i=!1,o=[];return e.oneOf.forEach(function(e){var t=B(n,e,r);if(t)o=o.concat(t);else{if(i)return o=[ea("valid against more than one","valid against only one",r)],i=!1;i=!0}}),i?void 0:o},pattern:function pattern(e,t,n){var pattern=t.pattern;if(x.isString(e)&&!e.match(pattern))return ea(e,pattern,n)},properties:function properties(i,e,o){if(o=o||{},!x.isArray(i)){var t=void 0===e.additionalProperties||e.additionalProperties,a=[],properties=e.properties||{},n=e.patternProperties||{},s=[];x.forOwn(properties,function(e,t){o.prop=t,s=s.concat(B(i[t],e,o)||[]),a.push(t)});var c=x.omit(i,a);x.forOwn(n,function(n,r){x.forOwn(c,function(e,t){t.match(r)&&(o.prop=t,s=s.concat(B(i[t],n,o)||[]),a.push(t))})});var r=Object.keys(x.omit(i,a));if(!1===t){if(r.length){var l=o.prop;o.prop="",fa("extra fields: ".concat(r.join(", ")),"no extra fields",o,s),o.prop=l}}else x.isObject(t)&&r.forEach(function(e){o.prop=e,s=s.concat(B(i[e],t,o)||[])});return s.length?s:void 0}},required:function required(n,e,r){r=r||{};var required=e.required,i=[];return r.existingOnly||required.forEach(function(e){if(void 0===x.get(n,e)){var t=r.prop;r.prop=e,fa(void 0,"a value",r,i),r.prop=t}}),i.length?i:void 0},type:function type(t,n,r){var i,type=n.type;if(x.isString(type)&&(type=[type]),type.forEach(function(e){if(M[e](t,n,r))return i=e,!1}),!i)return ea(null!=t?_typeof(t):""+t,"one of (".concat(type.join(", "),")"),r);var e=G[i];return e?e(t,n,r):void 0},uniqueItems:function uniqueItems(e,t,n){var r,i,o;if(e&&e.length&&t.uniqueItems)for(i=e.length-1;0<i;i--)for(r=e[i],o=i-1;0<=o;o--)if(x.deepEqual(r,e[o]))return ea(r,"no duplicates",n)}},D=["enum","type","allOf","anyOf","oneOf","not"],T=["items","maxItems","minItems","uniqueItems"],q=["multipleOf","maximum","minimum"],J=["maxProperties","minProperties","required","properties","dependencies"],Q=["maxLength","minLength","pattern"],B=function validate(e,t,n){var r,i=[];(n=n||{}).ctx||(n.ctx={value:e,schema:t});var o=n.prop;if(void 0!==t){if(!x.isObject(t))throw x.err("".concat("Schema","#validate"))(500,'Invalid schema at path: "'.concat(n.path,'"'));return(void 0===n.path&&(n.path=[]),void 0!==n.prop&&(r=!0,n.path.push(n.prop),n.prop=void 0),t.extends&&(i=x.isFunction(t.extends.validate)?i.concat(t.extends.validate(e,n)||[]):i.concat(B(e,t.extends,n)||[])),void 0===e)?(!0!==t.required||n.existingOnly||fa(e,"a value",n,i),r&&(n.path.pop(),n.prop=o),i.length?i:void 0):(i=i.concat(function validateAny(e,t,n){return ja(D,e,t,n)}(e,t,n)||[]),r&&(n.path.pop(),n.prop=o),i.length?i:void 0)}},H="changing",U="changed",V="history",$="eventId",G={array:function array(e,t,n){return ja(T,e,t,n)},integer:function integer(e,t,n){return G.numeric(e,t,n)},number:function number(e,t,n){return G.numeric(e,t,n)},numeric:function numeric(e,t,n){return ja(q,e,t,n)},object:function object(e,t,n){return ja(J,e,t,n)},string:function string(e,t,n){return ja(Q,e,t,n)}};function Fa(f){return function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];var i=n[n.length-f],o=i.op;if(this.dbg.apply(this,[o].concat(n)),-1!==z.indexOf(o)&&!1!==i.applyDefaults){var a=this.getSchema();if(a&&a.applyDefaults){var s=n[0];x.isArray(s)||(s=[s]),s.forEach(function(e){a.applyDefaults(e)})}}if(-1!==X.indexOf(o)&&!i.noValidate){var c=i.existingOnly;0===o.indexOf("beforeUpdate")&&void 0===i.existingOnly&&(i.existingOnly=!0);var l=this.validate(n["beforeUpdate"===o?1:0],x.pick(i,["existingOnly"]));if(i.existingOnly=c,l){var u=new Error("validation failed");return u.errors=l,x.reject(u)}}(i.notify||void 0===i.notify&&this.notify)&&setTimeout(function(){e.emit.apply(e,[o].concat(n))})}}var W=c.extend({constructor:function Schema(e){var r=this;e=e||{},x.fillIn(this,e),"object"===this.type?(this.properties=this.properties||{},x.forOwn(this.properties,function(e,t){e instanceof Schema||(r.properties[t]=new Schema(e))})):"array"!==this.type||!this.items||this.items instanceof Schema||(this.items=new Schema(this.items)),!this.extends||this.extends instanceof Schema||(this.extends=new Schema(this.extends)),["allOf","anyOf","oneOf"].forEach(function(n){r[n]&&r[n].forEach(function(e,t){e instanceof Schema||(r[n][t]=new Schema(e))})})},apply:function apply(n,r){var i=this;(r=r||{}).getter||(r.getter="_get"),r.setter||(r.setter="_set"),r.unsetter||(r.unsetter="_unset"),r.track||(r.track=this.track);var e=this.properties||{};x.forOwn(e,function(e,t){Object.defineProperty(n,t,i.makeDescriptor(t,e,r))})},applyDefaults:function applyDefaults(r){if(r){var e=this.properties||{},i=x.isFunction(r.set)||x.isFunction(r._set);x.forOwn(e,function(e,t){if(Object.hasOwnProperty.call(e,"default")&&void 0===x.get(r,t)&&(i?r.set(t,x.plainCopy(e.default),{silent:!0}):x.set(r,t,x.plainCopy(e.default))),"object"===e.type&&e.properties){if(i){var n=r._get("noValidate");r._set("noValidate",!0),x.set(r,t,x.get(r,t)||{},{silent:!0}),r._set("noValidate",n)}else x.set(r,t,x.get(r,t)||{});e.applyDefaults(x.get(r,t))}})}},makeDescriptor:function makeDescriptor(d,h,e){var t={configurable:!0,enumerable:void 0===h.enumerable||!!h.enumerable},p="props.".concat(d),v="previous.".concat(d),g=e.getter,y=e.setter,m=e.unsetter,A=x.isBoolean(e.track)?e.track:h.track;if(t.get=function(){return this._get(p)},x.isFunction(h.get)){var n=t.get;t.get=function(){return h.get.call(this,n)}}if(t.set=function(i){var o=this,a=this[g],s=this[y],c=this[m];if(!a("noValidate")){var e=h.validate(i,{path:[d]});if(e){var t=new Error("validation failed");throw t.errors=e,t}}if(A&&!a("creating")){var n=a(v),l=a(p),r=a(H),u=a(U);r||(u=[]);var f=u.indexOf(d);l!==i&&-1===f&&u.push(d),n===i&&0<=f&&u.splice(f,1),u.length||(r=!1,c(H),c(U),a($)&&(clearTimeout(a($)),c($))),!r&&u.length&&(s(U,u),s(H,!0),s($,setTimeout(function(){if(c(U),c($),c(H),!a("silent")){var e;for(e=0;e<u.length;e++)o.emit("change:"+u[e],o,x.get(o,u[e]));var t=x.diffObjects(_defineProperty({},d,i),_defineProperty({},d,l));if(a("keepChangeHistory")){var n=x.plainCopy(t);n.timestamp=(new Date).getTime();var r=a(V);r||s(V,r=[]),r.push(n)}o.emit("change",o,t)}c("silent")},0)))}return s(p,i),i},x.isFunction(h.set)){var r=t.set;t.set=function(e){return h.set.call(this,e,r)}}return t},pick:function pick(n){var r=this;if(void 0!==n){if("object"!==this.type)return"array"===this.type?n.map(function(e){var t=r.items?r.items.pick(e):{};return r.extends&&x.fillIn(t,r.extends.pick(e)),t}):x.plainCopy(n);var i={},e=this.properties;if(e&&x.forOwn(e,function(e,t){i[t]=e.pick(n[t])}),this.extends&&x.fillIn(i,this.extends.pick(n)),this.additionalProperties)for(var t in n)e[t]||(i[t]=x.plainCopy(n[t]));return i}},validate:function validate(e,t){return B(e,this,t)}},{ANY_OPS:D,ARRAY_OPS:T,NUMERIC_OPS:q,OBJECT_OPS:J,STRING_OPS:Q,typeGroupValidators:G,types:M,validate:B,validationKeywords:K}),Y="Mapper",z=["beforeCreate","beforeCreateMany"],X=["beforeCreate","beforeCreateMany","beforeUpdate","beforeUpdateAll","beforeUpdateMany"],Z=Fa(1),ee=Fa(2),te={count:{defaults:[{},{}],skip:!0,types:[]},destroy:{defaults:[{},{}],skip:!0,types:[]},destroyAll:{defaults:[{},{}],skip:!0,types:[]},find:{defaults:[void 0,{}],types:[]},findAll:{defaults:[{},{}],types:[]},sum:{defaults:[void 0,{},{}],skip:!0,types:[]},update:{adapterArgs:function adapterArgs(e,t,n,r){return[t,e.toJSON(n,r),r]},beforeAssign:1,defaults:[void 0,{},{}],types:[]},updateAll:{adapterArgs:function adapterArgs(e,t,n,r){return[e.toJSON(t,r),n,r]},beforeAssign:0,defaults:[{},{},{}],types:[]},updateMany:{adapterArgs:function adapterArgs(t,e,n){return[e.map(function(e){return t.toJSON(e,n)}),n]},beforeAssign:0,defaults:[[],{}],types:[]}},ne={_adapters:{},applyDefaults:!0,applySchema:!0,defaultAdapter:"http",idAttribute:"id",keepChangeHistory:!0,notify:!0,noValidate:!1,raw:!1,validateOnSet:!0};var re=c.extend({constructor:function Mapper(e){if(x.classCallCheck(this,Mapper),c.call(this),e=e||{},Object.defineProperties(this,{_adapters:{value:void 0,writable:!0},datastore:{value:void 0,writable:!0},lifecycleMethods:{value:te},recordClass:{value:void 0,writable:!0},schema:{value:void 0,writable:!0}}),x.fillIn(this,e),x.fillIn(this,x.copy(ne)),!this.name)throw x.err("new ".concat(Y),"opts.name")(400,"string",this.name);if(this.schema&&(this.schema.type||(this.schema.type="object"),this.schema instanceof W||(this.schema=new W(this.schema||{type:"object"}))),void 0===this.recordClass){var r=F;this.recordClass=r.extend({constructor:function Record(){var n=function Record(e,t){x.classCallCheck(this,n),r.call(this,e,t)};return n}()})}this.recordClass&&(this.recordClass.mapper=this,x.isObject(this.methods)&&x.addHiddenPropsToTarget(this.recordClass.prototype,this.methods),Object.isPrototypeOf.call(F,this.recordClass)&&this.schema&&this.schema.apply&&this.applySchema&&this.schema.apply(this.recordClass.prototype))},afterCount:ee,afterCreate:ee,afterCreateMany:ee,afterDestroy:ee,afterDestroyAll:ee,afterFind:ee,afterFindAll:ee,afterSum:ee,afterUpdate:ee,afterUpdateAll:ee,afterUpdateMany:ee,beforeCreate:Z,beforeCreateMany:Z,beforeCount:Z,beforeDestroy:Z,beforeDestroyAll:Z,beforeFind:Z,beforeFindAll:Z,beforeSum:Z,beforeUpdate:Z,beforeUpdateAll:Z,beforeUpdateMany:Z,_end:function _end(e,t,n){if(t.raw&&x._(e,t),n)return e;var r=t.raw?e.data:e;return r&&x.isFunction(this.wrap)&&(r=this.wrap(r,t),t.raw?e.data=r:e=r),e},belongsTo:function belongsTo$1(e,t){return N(e,t)(this)},count:function count(e,t){return this.crud("count",e,t)},create:function create(n,r){var i=this;r=r||{};var t=n=n||{},o={},a={};return x._(r,this),r.adapter=this.getAdapterName(r),r.op="beforeCreate",this._runHook(r.op,n,r).then(function(e){return r.with||(r.with=[]),i._createParentRecordIfRequired(e,r)}).then(function(e){o=e}).then(function(){return r.op="create",i._invokeAdapterMethod(r.op,n,r)}).then(function(e){a=e}).then(function(){var e=r.raw?a.data:a;return i._createOrAssignChildRecordIfRequired(e,{opts:r,parentRelationMap:o,originalProps:n})}).then(function(e){return i._commitChanges(t,e)}).then(function(e){r.raw?a.data=e:a=e;var t=i._end(a,r);return r.op="afterCreate",i._runHook(r.op,n,r,t)})},_commitChanges:function _commitChanges(e,n){var r=this;return x.isArray(e)?e.map(function(e,t){return r._commitChanges(e,n[t])}):(x.set(e,n,{silent:!0}),x.isFunction(e.commit)&&e.commit(),e)},createInstance:function createInstance(e,t){return this.createRecord(e,t)},_createParentRecordIfRequired:function _createParentRecordIfRequired(n,e){var r=[],i=[];return x.forEachRelation(this,e,function(e,t){e.isRequiresParentId()&&e.getLocalField(n)&&(t.raw=!1,i.push(e),r.push(e.createParentRecord(n,t)))}),x.Promise.all(r).then(function(r){return i.reduce(function(e,t,n){return t.setLocalField(e,r[n]),e},{})})},_createOrAssignChildRecordIfRequired:function _createOrAssignChildRecordIfRequired(i,o){var a=[];return x.forEachRelation(this,o.opts,function(e,t){var n=e.getLocalField(o.originalProps);if(n)if(t.raw=!1,e.isRequiresChildId())a.push(e.createChildRecord(i,n,t));else if(e.isRequiresParentId()){var r=e.getLocalField(o.parentRelationMap);r&&e.setLocalField(i,r)}}),x.Promise.all(a).then(function(){return i})},createMany:function createMany(e,n){var l=this;n=n||{};var r,t=e=e||[];return x._(n,this),n.adapter=this.getAdapterName(n),n.op="beforeCreateMany",this._runHook(n.op,e,n).then(function(a){var s={};n.with||(n.with=[]);var c=[];return x.forEachRelation(l,n,function(r,e){var t=a.map(function(e){return r.getLocalField(e)}).filter(Boolean);r.type===C&&t.length===a.length&&(e.raw=!1,c.push(r.createLinked(t,e).then(function(n){a.forEach(function(e,t){return r.setForeignKey(e,n[t])})}).then(function(e){r.setLocalField(s,e)})))}),x.Promise.all(c).then(function(){return n.op="createMany",l._invokeAdapterMethod(n.op,a,n)}).then(function(e){r=e}).then(function(){var o=n.raw?r.data:r;return c=[],x.forEachRelation(l,n,function(r,e){var n=a.map(function(e){return r.getLocalField(e)}).filter(Boolean);if(n.length===a.length){e.raw=!1;var t,i=r.getLocalField(s);r.type===k?l.log("warn","deep createMany of hasMany type not supported!"):r.type===I?(o.forEach(function(e,t){r.setForeignKey(e,n[t])}),t=r.getRelation().createMany(n,e).then(function(n){o.forEach(function(e,t){r.setLocalField(e,n[t])})})):r.type===C&&i&&i.length===o.length&&o.forEach(function(e,t){r.setLocalField(e,i[t])}),t&&c.push(t)}}),x.Promise.all(c).then(function(){return l._commitChanges(t,o)})})}).then(function(e){n.raw?r.data=e:r=e;var t=l._end(r,n);return n.op="afterCreateMany",l._runHook(n.op,e,n,t)})},createRecord:function createRecord(t,n){var r=this;if(t=t||{},x.isArray(t))return t.map(function(e){return r.createRecord(e,n)});if(!x.isObject(t))throw x.err("".concat(Y,"#createRecord"),"props")(400,"array or object",t);this.relationList&&this.relationList.forEach(function(e){e.ensureLinkedDataHasProperType(t,n)});var e=this.recordClass;return!e||t instanceof e?t:new e(t,n)},crud:function crud(n){for(var r=this,e=arguments.length,i=new Array(1<e?e-1:0),t=1;t<e;t++)i[t-1]=arguments[t];var o=this.lifecycleMethods[n];if(!o)throw x.err("".concat(Y,"#crud"),n)(404,"method");var a,s="".concat(n.charAt(0).toUpperCase()).concat(n.substr(1)),c="before".concat(s),l="after".concat(s);o.defaults.forEach(function(e,t){void 0===i[t]&&(i[t]=x.copy(e))});var u=i[i.length-1];x._(u,this);var f=u.adapter=this.getAdapterName(u);return a=u.op=c,x.resolve(this[a].apply(this,_toConsumableArray(i))).then(function(e){var t;return void 0!==i[o.beforeAssign]&&(i[o.beforeAssign]=void 0===e?i[o.beforeAssign]:e),a=u.op=n,i=o.adapterArgs?o.adapterArgs.apply(o,[r].concat(_toConsumableArray(i))):i,r.dbg.apply(r,[a].concat(_toConsumableArray(i))),x.resolve((t=r.getAdapter(f))[a].apply(t,[r].concat(_toConsumableArray(i))))}).then(function(t){var e=/find/.test(a)||u.noValidate,n=Object.assign({},u,{noValidate:e});return t=r._end(t,n,!!o.skip),i.push(t),a=u.op=l,x.resolve(r[a].apply(r,_toConsumableArray(i))).then(function(e){return void 0===e?t:e})})},destroy:function destroy(e,t){return this.crud("destroy",e,t)},destroyAll:function destroyAll(e,t){return this.crud("destroyAll",e,t)},find:function find(e,t){return this.crud("find",e,t)},findAll:function findAll(e,t){return this.crud("findAll",e,t)},getAdapter:function getAdapter(e){this.dbg("getAdapter","name:",e);var t=this.getAdapterName(e);if(!t)throw x.err("".concat(Y,"#getAdapter"),"name")(400,"string",e);return this.getAdapters()[t]},getAdapterName:function getAdapterName(e){return e=e||{},x.isString(e)&&(e={adapter:e}),e.adapter||e.defaultAdapter},getAdapters:function getAdapters(){return this._adapters},getSchema:function getSchema(){return this.schema},hasMany:function hasMany$1(e,t){return O(e,t)(this)},hasOne:function hasOne$1(e,t){return P(e,t)(this)},is:function is(e){var t=this.recordClass;return!!t&&e instanceof t},registerAdapter:function registerAdapter(e,t,n){n=n||{},this.getAdapters()[e]=t,!0!==n&&!n.default||(this.defaultAdapter=e)},_runHook:function _runHook(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=0===e.indexOf("after")?n.length-1:0;return x.resolve(this[e].apply(this,n)).then(function(e){return void 0===e?n[i]:e})},_invokeAdapterMethod:function _invokeAdapterMethod(e,t,n){var r,i=this,o={with:n.pass||[]};return this.dbg(n.op,t,n),r=x.isArray(t)?t.map(function(e){return i.toJSON(e,o)}):this.toJSON(t,o),this.getAdapter(n.adapter)[e](this,r,n)},sum:function sum(e,t,n){return this.crud("sum",e,t,n)},toJSON:function toJSON(e,t){var r,n=this;if(t=t||{},x.isArray(e))return e.map(function(e){return n.toJSON(e,t)});r=e;var i=(this?this.relationFields:[])||[],o={};if(this&&this.schema)o=this.schema.pick(r);else for(var a in r)-1===i.indexOf(a)&&(o[a]=x.plainCopy(r[a]));return this&&t.withAll&&(t.with=i.slice()),this&&t.with&&(x.isString(t.with)&&(t.with=[t.with]),x.forEachRelation(this,t,function(t,n){var e=t.getLocalField(r);e&&(x.isArray(e)?t.setLocalField(o,e.map(function(e){return t.getRelation().toJSON(e,n)})):t.setLocalField(o,t.getRelation().toJSON(e,n)))})),o},update:function update(e,t,n){return this.crud("update",e,t,n)},updateAll:function updateAll(e,t,n){return this.crud("updateAll",e,t,n)},updateMany:function updateMany(e,t){return this.crud("updateMany",e,t)},validate:function validate(e,t){t=t||{};var n=this.getSchema();if(n){var r=x.pick(t,["existingOnly"]);if(x.isArray(e)){var i=e.map(function(e){return n.validate(e,x.pick(r,["existingOnly"]))});return i.some(Boolean)?i:void 0}return n.validate(e,r)}},wrap:function wrap(e,t){return this.createRecord(e,t)},defineRelations:function defineRelations(){var i=this;x.forOwn(this.relations,function(e,r){x.forOwn(e,function(e,n){x.isObject(e)&&(e=[e]),e.forEach(function(e){var t=i.datastore.getMapperByName(n)||n;if(e.getRelation=function(){return i.datastore.getMapper(n)},"function"!=typeof Relation[r])throw x.err(Y,"defineRelations")(400,"relation type (hasOne, hasMany, etc)",r,!0);i[r](t,e)})})})}}),ie="Container",oe=["count","create","createMany","createRecord","destroy","destroyAll","find","findAll","getSchema","is","sum","toJSON","update","updateAll","updateMany","validate"];function Container(e){x.classCallCheck(this,Container),c.call(this),e=e||{},Object.defineProperties(this,{_adapters:{value:{}},_mappers:{value:{}},mapperClass:{value:void 0,writable:!0}}),x.fillIn(this,e),this.mapperDefaults=this.mapperDefaults||{},this.mapperClass||(this.mapperClass=re)}var ae={constructor:Container,_onMapperEvent:function _onMapperEvent(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=n.shift();this.emit.apply(this,[i,e].concat(n))},as:function as(i){var e={},o=this;return oe.forEach(function(r){e[r]={writable:!0,value:function value(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o[r].apply(o,[i].concat(t))}}}),e.getMapper={writable:!0,value:function value(){return o.getMapper(i)}},Object.create(this,e)},defineMapper:function defineMapper(r,e){var i=this;if(x.isObject(r)&&(r=(e=r).name),!x.isString(r))throw x.err("".concat(ie,"#defineMapper"),"name")(400,"string",r);(e=e||{}).name=r,e.relations||(e.relations={});var t=e.mapperClass||this.mapperClass;delete e.mapperClass,x.fillIn(e,this.mapperDefaults);var n=this._mappers[r]=new t(e);return n.relations||(n.relations={}),n.name=r,n._adapters=this.getAdapters(),n.datastore=this,n.on("all",function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i._onMapperEvent.apply(i,[r].concat(t))}),n.defineRelations(),n},defineResource:function defineResource(e,t){return console.warn("DEPRECATED: defineResource is deprecated, use defineMapper instead"),this.defineMapper(e,t)},getAdapter:function getAdapter(e){var t=this.getAdapterName(e);if(!t)throw x.err("".concat(ie,"#getAdapter"),"name")(400,"string",e);return this.getAdapters()[t]},getAdapterName:function getAdapterName(e){return e=e||{},x.isString(e)&&(e={adapter:e}),e.adapter||this.mapperDefaults.defaultAdapter},getAdapters:function getAdapters(){return this._adapters},getMapper:function getMapper(e){var t=this.getMapperByName(e);if(!t)throw x.err("".concat(ie,"#getMapper"),e)(404,"mapper");return t},getMapperByName:function getMapperByName(e){return this._mappers[e]},registerAdapter:function registerAdapter(t,e,n){n=n||{},this.getAdapters()[t]=e,!0!==n&&!n.default||(this.mapperDefaults.defaultAdapter=t,x.forOwn(this._mappers,function(e){e.defaultAdapter=t}))}};oe.forEach(function(o){ae[o]=function(e){for(var t,n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(t=this.getMapper(e))[o].apply(t,r)}}),c.extend(ae);function Ra(e,t,n){var r=this._completedQueries[e][t];return x.isFunction(r)?r(e,t,n):r}var se=["add","between","createIndex","filter","get","getAll","prune","query","toJSON","unsaved"],ce=["addToCache","cachedFind","cachedFindAll","cacheFind","cacheFindAll","hashQuery"],le={usePendingFind:!0,usePendingFindAll:!0};var ue={constructor:function SimpleStore(e){x.classCallCheck(this,SimpleStore),e=e||{},x.fillIn(e,le),Container.call(this,e),this.collectionClass=this.collectionClass||L,this._collections={},this._pendingQueries={},this._completedQueries={}},_end:function _end(e,t,n){var r=n.raw?t.data:t;return r&&x.isFunction(this.addToCache)&&(r=this.addToCache(e,r,n),n.raw?t.data=r:t=r),t},_onCollectionEvent:function _onCollectionEvent(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=n.shift();this.emit.apply(this,[i,e].concat(n))},addToCache:function addToCache(e,t,n){return this.getCollection(e).add(t,n)},as:function as(i){var e={},o=this;return ce.concat(oe).concat(se).forEach(function(r){e[r]={writable:!0,value:function value(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o[r].apply(o,[i].concat(t))}}}),e.getMapper={writable:!0,value:function value(){return o.getMapper(i)}},e.getCollection={writable:!0,value:function value(){return o.getCollection(i)}},Object.create(this,e)},cachedFind:Ra,cachedFindAll:Ra,cacheFind:function cacheFind(e,t,n){var r=this;this._completedQueries[e][n]=function(e,t,n){return r.get(e,t)}},cacheFindAll:function cacheFindAll(e,t,n){var r=this;this._completedQueries[e][n]=function(e,t,n){return r.filter(e,x.fromJson(t))}},clear:function clear(){var n=this,r={};return x.forOwn(this._collections,function(e,t){r[t]=e.removeAll(),n._completedQueries[t]={}}),r},create:function create(t,e,n){var r=this;return n=n||{},Container.prototype.create.call(this,t,e,n).then(function(e){return r._end(t,e,n)})},createMany:function createMany(t,e,n){var r=this;return n=n||{},Container.prototype.createMany.call(this,t,e,n).then(function(e){return r._end(t,e,n)})},defineMapper:function defineMapper(r,e){var i=this,t=Container.prototype.defineMapper.call(i,r,e);i._pendingQueries[r]={},i._completedQueries[r]={},t.relationList||Object.defineProperty(t,"relationList",{value:[]});var n={_added:{},datastore:i,mapper:t};e&&"onConflict"in e&&(n.onConflict=e.onConflict);var o=i._collections[r]=new i.collectionClass(null,n),a=(t.schema||{}).properties||{};return x.forOwn(a,function(e,t){e.indexed&&o.createIndex(t)}),o.createIndex("addedTimestamps",["$"],{fieldGetter:function fieldGetter(e){return o._added[o.recordId(e)]}}),o.on("all",function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];i._onCollectionEvent.apply(i,[r].concat(t))}),t},destroy:function destroy(n,r,i){var o=this;return i=i||{},Container.prototype.destroy.call(this,n,r,i).then(function(e){var t=o.getCollection(n).remove(r,i);return i.raw?e.data=t:e=t,delete o._pendingQueries[n][r],delete o._completedQueries[n][r],e})},destroyAll:function destroyAll(r,i,o){var a=this;return o=o||{},Container.prototype.destroyAll.call(this,r,i,o).then(function(e){var t=a.getCollection(r).removeAll(i,o);o.raw?e.data=t:e=t;var n=a.hashQuery(r,i,o);return delete a._pendingQueries[r][n],delete a._completedQueries[r][n],e})},eject:function eject(e,t,n){return console.warn('DEPRECATED: "eject" is deprecated, use "remove" instead'),this.remove(e,t,n)},ejectAll:function ejectAll(e,t,n){return console.warn('DEPRECATED: "ejectAll" is deprecated, use "removeAll" instead'),this.removeAll(e,t,n)},find:function find(t,n,r){var i=this;r=r||{};var e=this.getMapper(t),o=this._pendingQueries[t][n],a=void 0===r.usePendingFind?this.usePendingFind:r.usePendingFind;if(x._(r,e),o&&(x.isFunction(a)?a.call(this,t,n,r):a))return o;var s=this.cachedFind(t,n,r);return!r.force&&s?x.resolve(s):(this._pendingQueries[t][n]=Container.prototype.find.call(this,t,n,r)).then(function(e){return delete i._pendingQueries[t][n],e=i._end(t,e,r),i.cacheFind(t,e,n,r),e},function(e){return delete i._pendingQueries[t][n],x.reject(e)})},findAll:function findAll(t,e,n){var r=this;n=n||{};var i=this.getMapper(t),o=this.hashQuery(t,e,n),a=this._pendingQueries[t][o],s=void 0===n.usePendingFindAll?this.usePendingFindAll:n.usePendingFindAll;if(x._(n,i),a&&(x.isFunction(s)?s.call(this,t,e,n):s))return a;var c=this.cachedFindAll(t,o,n);return!n.force&&c?x.resolve(c):(this._pendingQueries[t][o]=Container.prototype.findAll.call(this,t,e,n)).then(function(e){return delete r._pendingQueries[t][o],e=r._end(t,e,n),r.cacheFindAll(t,e,o,n),e},function(e){return delete r._pendingQueries[t][o],x.reject(e)})},getCollection:function getCollection(e){var t=this._collections[e];if(!t)throw x.err("".concat("SimpleStore","#getCollection"),e)(404,"collection");return t},hashQuery:function hashQuery(e,t){return x.toJson(t||{})},inject:function inject(e,t,n){return console.warn('DEPRECATED: "inject" is deprecated, use "add" instead'),this.add(e,t,n)},remove:function remove(e,t,n){var r=this.getCollection(e).remove(t,n);return r&&this.removeRelated(e,[r],n),r},removeAll:function removeAll(e,t,n){t&&Object.keys(t).length?this._completedQueries[e][this.hashQuery(e,t,n)]=void 0:this._completedQueries[e]={};var r=this.getCollection(e).removeAll(t,n);return r.length&&this.removeRelated(e,r,n),r},removeRelated:function removeRelated(e,t,n){var o=this;x.isArray(t)||(t=[t]),x.forEachRelation(this.getMapper(e),n,function(r,i){t.forEach(function(e){var t,n;if(!r.foreignKey||r.type!==I&&r.type!==k?r.type===k&&r.localKeys?n={where:_defineProperty({},r.getRelation().idAttribute,{in:x.get(e,r.localKeys)})}:r.type===k&&r.foreignKeys?n={where:_defineProperty({},r.foreignKeys,{contains:r.getForeignKey(e)})}:r.type===C&&(t=o.remove(r.relation,r.getForeignKey(e),i)):n=_defineProperty({},r.foreignKey,r.getForeignKey(e)),n&&(t=o.removeAll(r.relation,n,i)),t){if(x.isArray(t)&&!t.length)return;r.type===I&&(t=t[0]),r.setLocalField(e,t)}})})},update:function update(t,e,n,r){var i=this;return r=r||{},Container.prototype.update.call(this,t,e,n,r).then(function(e){return i._end(t,e,r)})},updateAll:function updateAll(t,e,n,r){var i=this;return r=r||{},Container.prototype.updateAll.call(this,t,e,n,r).then(function(e){return i._end(t,e,r)})},updateMany:function updateMany(t,e,n){var r=this;return n=n||{},Container.prototype.updateMany.call(this,t,e,n).then(function(e){return r._end(t,e,n)})}};se.forEach(function(o){ue[o]=function(e){for(var t,n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(t=this.getCollection(e))[o].apply(t,r)}});var fe=Container.extend(ue),de="LinkedCollection";var he=L.extend({constructor:function LinkedCollection(e,t){if(x.classCallCheck(this,LinkedCollection),Object.defineProperties(this,{_added:{value:{}},datastore:{writable:!0,value:void 0}}),L.call(this,e,t),!this.datastore)throw x.err("new ".concat(de),"opts.datastore")(400,"DataStore",this.datastore)},_addMeta:function _addMeta(e,t){this._added[this.recordId(e)]=t,x.isFunction(e._set)&&e._set("$",t)},_clearMeta:function _clearMeta(e){delete this._added[this.recordId(e)],x.isFunction(e._set)&&e._set("$")},_onRecordEvent:function _onRecordEvent(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];L.prototype._onRecordEvent.apply(this,t);var r=t[0];x.isString(r)&&0===r.indexOf("change")&&this.updateIndexes(t[1])},add:function add(t,e){var n=this,r=this.mapper,i=(new Date).getTime(),o=x.isObject(t)&&!x.isArray(t);return o&&(t=[t]),t=L.prototype.add.call(this,t,e),r.relationList.length&&t.length&&r.relationList.forEach(function(e){e.addLinkedRecords(t)}),t.forEach(function(e){return n._addMeta(e,i)}),o?t[0]:t},remove:function remove(e,t){var n=this.mapper,r=L.prototype.remove.call(this,e,t);return r&&this._clearMeta(r),n.relationList.length&&r&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,[r])}),r},removeAll:function removeAll(e,t){var n=this.mapper,r=L.prototype.removeAll.call(this,e,t);return r.forEach(this._clearMeta,this),n.relationList.length&&r.length&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,r)}),r}}),pe={unlinkOnDestroy:!0};var ve={constructor:function DataStore(e){x.classCallCheck(this,DataStore),e=e||{},x.fillIn(e,pe),e.collectionClass||(e.collectionClass=he),fe.call(this,e)},defineMapper:function defineMapper(e,t){var A=this,b=fe.prototype.defineMapper.call(A,e,t),_=b.idAttribute,l=this.getCollection(e);return b.relationList.forEach(function(u){function pA(){return this._get(h)}var e,f=u.relation,d=u.localField,h="links.".concat(d),p=u.foreignKey,t=u.type,g={index:p};if(t===C){l.indexes[p]||l.createIndex(p),e={get:pA,set:function set(e){var t=this._get(h);if(e===t)return t;var n=x.get(this,_),r=u.getInverse(b);if(t&&r&&this.removeInverseRelation(t,n,r,_),e){var i=u.getRelation().idAttribute,o=x.get(e,i);void 0!==o&&this._get("$")&&(e=A.get(f,o)||e),w(this,d,e),v(this,p,o),l.updateIndex(this,g),r&&this.setupInverseRelation(e,n,r,_)}else w(this,d,void 0);return e}};var n=Object.getOwnPropertyDescriptor(b.recordClass.prototype,p),r=(n=n||{enumerable:!0}).get;n.get=function(){return r?r.call(this):this._get("props.".concat(p))};var c=n.set;n.set=function(e){var t=this;c&&c.call(this,e);var n=x.get(this,d),r=x.get(this,_),i=u.getInverse(b),o=n?x.get(n,u.getRelation().idAttribute):void 0;if(i&&n&&void 0!==o&&o!==e)if(i.type===I)w(n,i.localField,void 0);else if(i.type===k){var a=x.get(n,i.localField);void 0===r?x.remove(a,function(e){return e===t}):x.remove(a,function(e){return e===t||r===x.get(e,_)})}if(v(this,p,e),l.updateIndex(this,g),null==e)void 0!==o&&x.set(this,d,void 0);else if(this._get("$")){var s=A.get(f,e);s&&x.set(this,d,s)}},Object.defineProperty(b.recordClass.prototype,p,n)}else if(t===k){var y=u.localKeys,m=u.foreignKeys;A._collections[f]&&p&&!A.getCollection(f).indexes[p]&&A.getCollection(f).createIndex(p),e={get:function get(){return pA.call(this)||this._set(h,[]),pA.call(this)},set:function set(n){var i=this;n&&!x.isArray(n)&&(n=[n]);var r=x.get(this,_),o=u.getRelation().idAttribute,e=u.getInverse(b),a=e.localField,t=this._get(h)||[],s=[],c={};if(n&&n.forEach(function(t){var n=x.get(t,o),e=x.get(t,a);if(e&&e!==i){var r=x.get(e,d);void 0===n?x.remove(r,function(e){return e===t}):x.remove(r,function(e){return e===t||n===x.get(e,o)})}void 0!==n&&(i._get("$")&&(t=A.get(f,n)||t),c[n]=t),s.push(t)}),p)t.forEach(function(e){var t=x.get(e,o);(void 0!==t||-1!==s.indexOf(e))&&(void 0===t||t in c)||(n&&(v(e,p,void 0),A.getCollection(f).updateIndex(e,g)),w(e,a,void 0))}),s.forEach(function(e){v(e,p,r),A.getCollection(f).updateIndex(e,g),w(e,a,i)});else if(y){var l=s.map(function(e){return x.get(e,o)}).filter(function(e){return void 0!==e});x.set(this,y,l),e.foreignKeys&&(t.forEach(function(e){var t=x.get(e,o);if(void 0===t&&-1===s.indexOf(e)||void 0!==t&&!(t in c)){var n=x.get(e,a)||[];void 0===r?x.remove(n,function(e){return e===i}):x.remove(n,function(e){return e===i||r===x.get(e,_)})}}),s.forEach(function(e){var t=x.get(e,a);void 0===r?x.noDupeAdd(t,i,function(e){return e===i}):x.noDupeAdd(t,i,function(e){return e===i||r===x.get(e,_)})}))}else m&&(t.forEach(function(e){var t=x.get(e,m)||[];x.remove(t,function(e){return r===e});var n=x.get(e,a);void 0===r?x.remove(n,function(e){return e===i}):x.remove(n,function(e){return e===i||r===x.get(e,_)})}),s.forEach(function(e){var t=x.get(e,m)||[];x.noDupeAdd(t,r,function(e){return r===e});var n=x.get(e,a);void 0===r?x.noDupeAdd(n,i,function(e){return e===i}):x.noDupeAdd(n,i,function(e){return e===i||r===x.get(e,_)})}));return this._set(h,s),s}}}else t===I&&(A._collections[f]&&p&&!A.getCollection(f).indexes[p]&&A.getCollection(f).createIndex(p),e={get:pA,set:function set(e){var t=this._get(h);if(e===t)return t;var n=u.getInverse(b).localField;if(t&&(v(t,p,void 0),A.getCollection(f).updateIndex(t,g),w(t,n,void 0)),e){var r=x.get(e,u.getRelation().idAttribute);void 0!==r&&(e=A.get(f,r)||e),w(this,d,e),v(e,p,x.get(this,_)),A.getCollection(f).updateIndex(e,g),w(e,n,this)}else w(this,d,void 0);return e}});if(e){if(e.enumerable=void 0!==u.enumerable&&u.enumerable,u.get){var i=e.get;e.get=function(){var r=this;return u.get(u,this,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.apply(r,t)})}}if(u.set){var o=e.set;e.set=function(t){var n=this;return u.set(u,this,t,function(e){return o.call(n,void 0===e?t:e)})}}Object.defineProperty(b.recordClass.prototype,d,e)}}),b},destroy:function destroy(r,e,i){var o=this;return i=i||{},fe.prototype.destroy.call(this,r,e,i).then(function(e){var t;if((t=i.raw?e.data:e)&&o.unlinkOnDestroy){var n=x.plainCopy(i);n.withAll=!0,x.forEachRelation(o.getMapper(r),n,function(e){x.set(t,e.localField,void 0)})}return e})},destroyAll:function destroyAll(r,e,i){var o=this;return i=i||{},fe.prototype.destroyAll.call(this,r,e,i).then(function(e){var n;if((n=i.raw?e.data:e)&&n.length&&o.unlinkOnDestroy){var t=x.plainCopy(i);t.withAll=!0,x.forEachRelation(o.getMapper(r),t,function(t){n.forEach(function(e){x.set(e,t.localField,void 0)})})}return e})}},ge=fe.extend(ve);e.Collection=L,e.Component=c,e.Container=Container,e.DataStore=ge,e.Index=Index,e.LinkedCollection=he,e.Mapper=re,e.Query=g,e.Record=F,e.Schema=W,e.Settable=Settable,e.SimpleStore=fe,e.belongsTo=N,e.belongsToType=C,e.hasMany=O,e.hasManyType=k,e.hasOne=P,e.hasOneType=I,e.utils=x,e.version={full:"3.0.6",major:3,minor:0,patch:6},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=js-data.min.map